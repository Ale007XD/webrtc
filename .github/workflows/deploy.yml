name: Deploy WebRTC E2EE

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Verify required files
      run: |
        echo "Checking required files..."
        ls -la
        [ -f docker-compose.yml ] || (echo "‚ùå docker-compose.yml not found" && exit 1)
        [ -d proxy ] || (echo "‚ùå proxy/ directory not found" && exit 1)
        [ -d turn ] || (echo "‚ùå turn/ directory not found" && exit 1)
        [ -d scripts ] || (echo "‚ùå scripts/ directory not found" && exit 1)
        echo "‚úÖ All required files present"
        
    - name: Create deployment archive
      run: |
        tar -czf deployment.tar.gz \
          docker-compose.yml \
          proxy/ \
          turn/ \
          scripts/
        ls -la deployment.tar.gz
        
    - name: Transfer files to VPS
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        source: deployment.tar.gz
        target: /opt/webrtc-e2ee/
        
    - name: Deploy on VPS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          cd /opt/webrtc-e2ee/
          tar -xzf deployment.tar.gz
          chmod +x scripts/*.sh
          ./scripts/deploy.sh
          
    - name: Deployment notification
      if: always()
      run: |
        if [[ "${{ job.status }}" == "success" ]]; then
          echo "‚úÖ Deployment successful to ${{ secrets.VPS_HOST }}"
          echo "üåê Application URL: ${{ secrets.APP_PUBLIC_URL }}"
        else
          echo "‚ùå Deployment failed"
        fi
